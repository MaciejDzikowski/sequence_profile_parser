<html>

<head>
    <title>
        sequence profile parser
    </title>

    <script src="brython.js"></script>
    <style>

        .center {
            text-align: center;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .tooltip {
            text-align: center;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .loader {
            display: none;
            width: 46px;
            height: 46px;
            margin: 1px;
            border-radius: 50%;
            border: 5px solid #0009cc;
            border-color: #0009cc transparent #0009cc transparent;
            animation: loader 1.2s linear infinite;
        }
        @keyframes loader {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

    </style>
</head>

<body onload="brython()">

<script type="text/python">
    import sys
    import sequence_profile_io as spi
    from browser import document, html, window

    sys.path.append('/core')
    from core.SvgViewport import SvgViewport
    from core.styles import color_by_name, colormap_by_name
    from core.svg_elements import Text, SquaresGroup


    def handle_file_dragged_over(evt):
        """
        lets user to drop a file
        """
        evt.stopPropagation()
        evt.preventDefault()
        evt.dataTransfer.dropEffect = 'copy'


    def show_loader():
        """
        shows loader
        """
        document["loader"].style.display= "block"


    def load_file():
        """
        loading the file and creating a svg
        """
        text = reader.result
        try:
            order, sequence, matrix = spi.parse_sequence_profile_text(text)

            drawing = SvgViewport('',
                                   0,
                                   0,
                                   24 * len(sequence) - 4 + 55 + 50,
                                   # width + space for amino acids' shortcuts + margin
                                   24 * len(order) + 20)  # height + space for sequence

            cmap = colormap_by_name("magma", 0.0, 1.0)

            # drawing a group of squares
            x_data = []
            y_data = []
            colors = []
            for i in range(len(sequence)):
                for j in range(len(order)):
                    x_data.append(i * 24 + 55)
                    # '55' to create space for amino acids' shortcuts
                    y_data.append(j * 24 + 11)  # '11' to match squaresgroup
                    colors.append(cmap.color(matrix[j][i]))
            gid = 'squaresgroup'
            r = SquaresGroup(gid, x_data, y_data, colors, a=20)
            r.stroke = 'Grey'
            drawing.draw(r)

            # drawing an order
            for i in range(len(order)):
                text = Text(str(order[i]))
                text.x = 25
                text.y = 24 * i + 16 + 1
                # '16' to center the shortcuts + '1' to show full squares
                color = color_by_name("Black")
                stroke = color_by_name("Black").create_darker(0.3)
                text.fill, text.stroke, text.stroke_width = color, stroke, 0.3
                text.font_size = 14
                drawing.draw(text)

            # drawing a sequence
            for i in range(len(sequence)):
                text = Text(str(sequence[i]))
                text.x = 55 + 24 * i  # '55' to match sequence to squares
                text.y = len(order) * 24 - 4 + 16 + 1
                # squares' width + '16' to match seq + '1' as above
                color = color_by_name("Black")
                stroke = color_by_name("Black").create_darker(0.3)
                text.fill, text.stroke, text.stroke_width = color, stroke, 0.3
                text.font_size = 12
                drawing.draw(text)

            drawing.close()

            # deleting the instruction and the loader
            document['instruction'].innerHTML = ''
            document["loader"].style.display="none"

            # displaying a svg
            document['svg'].innerHTML = drawing.innerHTML
            document['svg'].style['width'] = '%dpx' % (24 * len(sequence))
            document['svg'].style['height'] = '548px'

            # creating a list of tooltip's messages
            global messages
            messages = []
            for i in range(len(sequence)):
                for j in range(len(order)):
                    messages.append('%s/%s: %f' % (sequence[i],
                                                   order[j],
                                                   matrix[j][i]))

            # preparing a list of svg's elements (squares)
            elements = document['svg'].select('rect')
            for i in range(len(elements)):
                elements[i].id = str(i)
                elements[i].bind("mouseover", point_tooltip)

            return text
        except:
            # deplying an error and deleting the loader
            document['instruction'].innerHTML = 'Wrong file format!'
            document["loader"].style.display="none"
            print('Wrong file format!')


    def point_tooltip(ev):
        """
        preparing an adequate message
        """
        print('totltek')
        document["tooltip"].style.display = "inline"
        c = ev.target
        id = ev.target.id
        i = int(id)
        document["tooltip"].text = messages[i]


    def handle_file_dropped(evt):
        """
        an action after file dropping
        """
        evt.stopPropagation()
        evt.preventDefault()

        # displaying an instruction and showing a loader
        document['instruction'].innerHTML = 'Please wait...'
        show_loader()

        files = evt.dataTransfer.files  # FileList object.
        global reader
        reader = window.FileReader.new()
        reader.onload = load_file
        reader.readAsText(files[0])


    # setup the dnd listeners.
    drop_zone = document['view']
    drop_zone.bind('dragover', handle_file_dragged_over)
    drop_zone.bind('drop', handle_file_dropped)

</script>

</body>

<div class="center"><h1>Sequence profile parser</h1></div>

<div>
    <div id="instruction">Drop *.profile file onto the area below:</div>

    <div style="width: 150px; height: auto; margin-left: auto;
            margin-right: auto; border: 1px solid #ccc;">
        <div id="tooltip" class="tooltip"></div>
    </div>

    <div style="width: 1200px; height: auto; overflow: scroll;
            margin-left: auto; margin-right: auto; border: 1px solid #ccc;">
        <div id="view">
            <div id="loader" class="loader"></div>
            <svg id="svg" style="margin: 10px; height: auto"></svg>
        </div>
    </div>
</div>

</html>
